import { useState } from 'react';
import { Button } from './ui/button';
import { Input } from './ui/input';
import { Label } from './ui/label';
import { RadioGroup, RadioGroupItem } from './ui/radio-group';
import { ChevronRight, ChevronLeft, Check } from 'lucide-react';

interface OnboardingPageProps {
  onComplete: (data: any) => void;
}

export function OnboardingPage({ onComplete }: OnboardingPageProps) {
  const [step, setStep] = useState(1);
  const [formData, setFormData] = useState({
    fullName: '',
    phoneNumber: '',
    accountType: 'personal',
    monthlyIncome: '',
    financialGoals: [] as string[],
  });
  const [uploadedFile, setUploadedFile] = useState<File | null>(null);
  const [parsedTransactions, setParsedTransactions] = useState<any[]>([]);

  const totalSteps = 4;

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setUploadedFile(file);
      parseCSV(file);
    }
  };

  const parseCSV = (file: File) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target?.result as string;
      const lines = text.split('\n');
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      
      const transactions = lines.slice(1)
        .filter(line => line.trim())
        .map((line, index) => {
          const values = line.split(',').map(v => v.trim());
          const transaction: any = { id: index + 1 };
          
          headers.forEach((header, i) => {
            // Handle common CSV column names
            if (header.includes('date')) transaction.date = values[i];
            else if (header.includes('description') || header.includes('narration') || header.includes('name')) {
              transaction.name = values[i];
            }
            else if (header.includes('amount') || header.includes('debit') || header.includes('credit')) {
              const amount = parseFloat(values[i].replace(/[^0-9.-]/g, ''));
              if (!isNaN(amount)) {
                // If it's a debit column or negative amount, make it negative
                if (header.includes('debit') || amount < 0) {
                  transaction.amount = -Math.abs(amount);
                  transaction.type = 'expense';
                } else {
                  transaction.amount = Math.abs(amount);
                  transaction.type = 'income';
                }
              }
            }
            else if (header.includes('category')) transaction.category = values[i];
            else if (header.includes('balance')) transaction.balance = parseFloat(values[i].replace(/[^0-9.-]/g, ''));
          });
          
          // Auto-categorize if no category provided
          if (!transaction.category && transaction.name) {
            const name = transaction.name.toLowerCase();
            if (name.includes('salary') || name.includes('income')) transaction.category = 'Salary';
            else if (name.includes('rent')) transaction.category = 'Bills';
            else if (name.includes('emi') || name.includes('loan')) transaction.category = 'EMI';
            else if (name.includes('food') || name.includes('restaurant') || name.includes('grocery')) transaction.category = 'Food';
            else if (name.includes('uber') || name.includes('transport') || name.includes('fuel')) transaction.category = 'Transport';
            else if (name.includes('amazon') || name.includes('shopping')) transaction.category = 'Shopping';
            else if (name.includes('netflix') || name.includes('entertainment')) transaction.category = 'Entertainment';
            else transaction.category = 'Other';
          }
          
          return transaction;
        })
        .filter(t => t.amount !== undefined);
      
      setParsedTransactions(transactions);
    };
    reader.readAsText(file);
  };

  const handleNext = () => {
    if (step < totalSteps) {
      setStep(step + 1);
    } else {
      onComplete({ transactions: parsedTransactions, userInfo: formData });
    }
  };

  const handleBack = () => {
    if (step > 1) {
      setStep(step - 1);
    }
  };

  const toggleGoal = (goal: string) => {
    setFormData(prev => ({
      ...prev,
      financialGoals: prev.financialGoals.includes(goal)
        ? prev.financialGoals.filter(g => g !== goal)
        : [...prev.financialGoals, goal]
    }));
    console.log('Goal clicked:', goal);
    console.log('Current goals:', formData.financialGoals);
  };

  return (
    <div className="min-h-screen w-full bg-[#0f172a] flex items-center justify-center p-8">
      <div className="w-full max-w-2xl">
        {/* Header */}
        <div className="text-left mb-8">
          <h1 className="text-2xl font-bold text-white">Financial Risk Radar</h1>
        </div>

        {/* Progress Bar */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-medium text-gray-400">Step {step} of {totalSteps}</span>
            <span className="text-sm font-medium text-[#3b82f6]">{Math.round((step / totalSteps) * 100)}%</span>
          </div>
          <div className="w-full h-2 bg-[#334155] rounded-full overflow-hidden">
            <div
              className="h-full bg-[#3b82f6] transition-all duration-300"
              style={{ width: `${(step / totalSteps) * 100}%` }}
            />
          </div>
        </div>

        {/* Step Content */}
        <div className="min-h-[400px]">
          {step === 1 && (
            <div className="space-y-6">
              <div className="space-y-2 text-center">
                <h2 className="text-3xl font-bold text-white">Connect your Financial Data</h2>
                <p className="text-gray-400">Upload your bank statement to generate your financial risk profile</p>
              </div>

              <div className="bg-[#1e293b] rounded-lg p-12 flex flex-col items-center justify-center space-y-6 border border-[#334155]">
                <div className="w-16 h-16 bg-white rounded-xl flex items-center justify-center">
                  <svg className="w-8 h-8 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                </div>
                {uploadedFile ? (
                  <div className="text-center space-y-2">
                    <p className="text-white font-medium">âœ“ {uploadedFile.name}</p>
                    <p className="text-sm text-green-400">File uploaded successfully</p>
                  </div>
                ) : (
                  <div className="text-center space-y-2">
                    <p className="text-white font-medium">Upload bank statement (CSV)</p>
                    <p className="text-sm text-gray-400">We do not store your data. Files are processed securely</p>
                  </div>
                )}
                <input
                  type="file"
                  accept=".csv,.pdf,.xlsx"
                  onChange={handleFileUpload}
                  className="hidden"
                  id="file-upload"
                />
                <Button
                  className="bg-[#475569] hover:bg-[#334155] text-white"
                  onClick={() => document.getElementById('file-upload')?.click()}
                >
                  {uploadedFile ? 'Change File' : 'Choose File'}
                </Button>
              </div>
            </div>
          )}

          {step === 2 && (
            <div className="space-y-6">
              <div className="space-y-2 text-center">
                <h2 className="text-3xl font-bold text-white">Choose your account type</h2>
                <p className="text-gray-400">Select the type that best fits your needs</p>
              </div>

              <RadioGroup value={formData.accountType} onValueChange={(value) => setFormData({ ...formData, accountType: value })}>
                <div className="space-y-3">
                  <div className={`flex items-center space-x-4 border-2 rounded-lg p-4 cursor-pointer transition-all ${formData.accountType === 'personal' ? 'border-[#3b82f6] bg-[#1e293b]' : 'border-[#334155] bg-[#1e293b]'}`}>
                    <RadioGroupItem value="personal" id="personal" />
                    <div className="flex-1">
                      <label htmlFor="personal" className="font-semibold cursor-pointer text-white">Personal Account</label>
                      <p className="text-sm text-gray-400">For individual banking needs</p>
                    </div>
                  </div>

                  <div className={`flex items-center space-x-4 border-2 rounded-lg p-4 cursor-pointer transition-all ${formData.accountType === 'business' ? 'border-[#3b82f6] bg-[#1e293b]' : 'border-[#334155] bg-[#1e293b]'}`}>
                    <RadioGroupItem value="business" id="business" />
                    <div className="flex-1">
                      <label htmlFor="business" className="font-semibold cursor-pointer text-white">Business Account</label>
                      <p className="text-sm text-gray-400">For business and company needs</p>
                    </div>
                  </div>

                  <div className={`flex items-center space-x-4 border-2 rounded-lg p-4 cursor-pointer transition-all ${formData.accountType === 'premium' ? 'border-[#3b82f6] bg-[#1e293b]' : 'border-[#334155] bg-[#1e293b]'}`}>
                    <RadioGroupItem value="premium" id="premium" />
                    <div className="flex-1">
                      <label htmlFor="premium" className="font-semibold cursor-pointer text-white">Premium Account</label>
                      <p className="text-sm text-gray-400">Enhanced features and priority support</p>
                    </div>
                  </div>
                </div>
              </RadioGroup>
            </div>
          )}

          {step === 3 && (
            <div className="space-y-6">
              <div className="space-y-2 text-center">
                <h2 className="text-3xl font-bold text-white">Financial information</h2>
                <p className="text-gray-400">Help us understand your financial situation</p>
              </div>

              <div className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="monthlyIncome" className="text-gray-300">Monthly Income (Optional)</Label>
                  <Input
                    id="monthlyIncome"
                    type="number"
                    placeholder="Enter your monthly income"
                    value={formData.monthlyIncome}
                    onChange={(e) => setFormData({ ...formData, monthlyIncome: e.target.value })}
                    className="bg-[#334155] border-transparent text-white placeholder:text-gray-500"
                  />
                </div>

                <div className="space-y-3">
                  <Label className="text-gray-300">What are your financial goals?</Label>
                  <div className="grid grid-cols-2 gap-3">
                    {['Save Money', 'Invest', 'Pay Debts', 'Budget Better', 'Build Credit', 'Plan Retirement'].map((goal) => (
                      <button
                        key={goal}
                        type="button"
                        onClick={() => toggleGoal(goal)}
                        className={`flex items-center justify-between p-4 border-2 rounded-lg transition-all ${
                          formData.financialGoals.includes(goal)
                            ? 'border-[#3b82f6] bg-[#1e293b]'
                            : 'border-[#334155] hover:border-[#475569] bg-[#1e293b]'
                        }`}
                      >
                        <span className="font-medium text-white">{goal}</span>
                        {formData.financialGoals.includes(goal) && (
                          <Check className="h-5 w-5 text-[#3b82f6]" />
                        )}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {step === 4 && (
            <div className="space-y-6 flex flex-col items-center justify-center text-center min-h-[400px]">
              <div className="w-20 h-20 rounded-full bg-[#3b82f6] flex items-center justify-center">
                <Check className="h-10 w-10 text-white" />
              </div>
              <div className="space-y-2">
                <h2 className="text-3xl font-bold text-white">You're all set!</h2>
                <p className="text-gray-400 max-w-md">
                  Your account has been configured successfully. Let's explore your new dashboard.
                </p>
              </div>

              <div className="grid grid-cols-3 gap-4 w-full max-w-md pt-4">
                <div className="p-4 bg-[#1e293b] rounded-lg border border-[#334155]">
                  <div className="text-2xl font-bold text-[#3b82f6]">1</div>
                  <div className="text-sm text-gray-400">Account</div>
                </div>
                <div className="p-4 bg-[#1e293b] rounded-lg border border-[#334155]">
                  <div className="text-2xl font-bold text-[#3b82f6]">24/7</div>
                  <div className="text-sm text-gray-400">Support</div>
                </div>
                <div className="p-4 bg-[#1e293b] rounded-lg border border-[#334155]">
                  <div className="text-2xl font-bold text-[#3b82f6]">100%</div>
                  <div className="text-sm text-gray-400">Secure</div>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Navigation Buttons */}
        <div className="flex items-center justify-between mt-8 pt-6">
          <Button
            variant="outline"
            onClick={handleBack}
            disabled={step === 1}
            className="flex items-center bg-[#334155] border-transparent text-white hover:bg-[#475569]"
          >
            <ChevronLeft className="h-4 w-4 mr-2" />
            Back
          </Button>

          <Button onClick={handleNext} className="flex items-center bg-[#3b82f6] hover:bg-[#2563eb] text-white">
            {step === totalSteps ? 'Get Started' : 'Continue'}
            <ChevronRight className="h-4 w-4 ml-2" />
          </Button>
        </div>
      </div>
    </div>
  );
}
